#!/bin/bash

# Marker file to ensure script runs only once
MARKER_FILE="$HOME/.config/minios/keyboard-configured"

# Exit if already executed
if [[ -f "$MARKER_FILE" ]]; then
    exit 0
fi

# Read keyboard-layouts parameter from /proc/cmdline
CMDLINE_KEYBOARD=$(grep -o 'keyboard-layouts=[^ ]*' /proc/cmdline 2>/dev/null | cut -d= -f2)

# If no keyboard parameter in cmdline, exit
if [ -z "$CMDLINE_KEYBOARD" ]; then
    exit 0
fi

# Detect desktop environment
if [ -n "$XFCE4_SESSION" ] || pgrep -x xfce4-session >/dev/null 2>&1; then
    # XFCE configuration
    if command -v xfconf-query >/dev/null 2>&1; then
        # Wait for xfconf to be ready
        timeout=10
        while ! xfconf-query -c keyboard-layout -l >/dev/null 2>&1 && [ $timeout -gt 0 ]; do
            sleep 0.5
            timeout=$((timeout - 1))
        done

        if [ $timeout -gt 0 ]; then
            # Set keyboard layout in XFCE
            xfconf-query -c keyboard-layout -p /Default/XkbLayout -s "$CMDLINE_KEYBOARD"
            xfconf-query -c keyboard-layout -p /Default/XkbDisable -s false

            # Set switch option (Alt+Shift)
            xfconf-query -c keyboard-layout -p /Default/XkbOptions/Group -s "grp:alt_shift_toggle"
        fi
    fi

elif pgrep -x fluxbox >/dev/null 2>&1 || pgrep -x openbox >/dev/null 2>&1; then
    # Fluxbox/Openbox configuration
    mkdir -p "$HOME/.fluxbox" "$HOME/.config/openbox"

    # Save to fluxbox kblayout file
    echo "$CMDLINE_KEYBOARD" > "$HOME/.fluxbox/kblayout"
    echo "$CMDLINE_KEYBOARD" > "$HOME/.config/openbox/kblayout"
fi

# Apply keyboard layout using setxkbmap (universal for all WMs)
if command -v setxkbmap >/dev/null 2>&1; then
    setxkbmap -layout "$CMDLINE_KEYBOARD" -option "grp:alt_shift_toggle"
fi

# Create marker file to prevent future runs
mkdir -p "$HOME/.config/minios"
touch "$MARKER_FILE"

exit 0
